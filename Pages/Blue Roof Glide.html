<!DOCTYPE html>
<html>
<head>
    <title>Scrolling Marquee</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://code.highcharts.com/highcharts.js"></script>
	<style>
        body, html, #container {
            height: 100%;
            margin: 0;
            overflow: hidden;
        }
    </style>
</head>
<body>
    <marquee id="marquee" behavior="scroll" direction="left" scrollamount="5"></marquee>

    <div id="container"></div>

    <script>
        $(document).ready(function(){
            var cumulativeData = {
                created_date: [],
                dateqacomplete: [],
                datesenttocontractor: [],
                datecontractorcomplete: []
            };

            function processData(data) {
                // Process data here and push to cumulativeData
                // Please replace with your actual data processing logic
                data.features.forEach(function(feature) {
                    var attr = feature.attributes;
                    var dates = [
                        attr.created_date, 
                        attr.dateqacomplete, 
                        attr.datesenttocontractor, 
                        attr.datecontractorcomplete
                    ];
                    dates.forEach(function(date, index) {
                        if (date) {
                            var dateObj = new Date(date);
                            var key = Object.keys(cumulativeData)[index];
                            cumulativeData[key].push([Date.UTC(dateObj.getFullYear(), dateObj.getMonth(), dateObj.getDate()), 1]);
                        }
                    });
                });
                
                Object.keys(cumulativeData).forEach(function(key) {
                    cumulativeData[key].sort(function(a, b) {
                        return a[0] - b[0];
                    });
                    
                    for (var i = 1; i < cumulativeData[key].length; i++) {
                        cumulativeData[key][i][1] += cumulativeData[key][i - 1][1];
                    }
                });

                createChart();
            }

            function requestData() {
                $.ajax({
                    url: "https://arcportal-ucop-corps.usace.army.mil/esf3/rest/services/TempRoofing/BRMS/FeatureServer/0/query", 
                    data: {
                        f: 'json',
                        where: "workstate='Valid'", 
                        outFields: 'created_date,dateqacomplete,datesenttocontractor,datecontractorcomplete', 
                        returnGeometry: false
                    },
                    success: function(data) {
                        processData(data);
                    },
                    error: function(jqXHR, textStatus, errorThrown) {
                        alert("Error: " + textStatus + "\n" + errorThrown);
                    }
                });
            }

            function createChart() {
                Highcharts.chart('container', {
                    chart: {
                        type: 'line'
                    },
                    title: {
                        text: 'Production Path'
                    },
					credits: {
						enabled: false
					  },
                    xAxis: {
                        type: 'datetime',
                        title: {
                            text: 'Date'
                        }
                    },
                    yAxis: {
                        title: {
                            text: 'Cumulative Total'
                        }
                    },
                    series: [{
                        name: 'Created Date',
                        data: cumulativeData.created_date
                    }, {
                        name: 'QA Complete Date',
                        data: cumulativeData.dateqacomplete
                    }, {
                        name: 'Sent to Contractor Date',
                        data: cumulativeData.datesenttocontractor
                    }, {
                        name: 'Contractor Complete Date',
                        data: cumulativeData.datecontractorcomplete
                    }]
                });
            }

            requestData();
        });
    </script>
</body>
</html>
